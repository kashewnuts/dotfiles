# Deep Performance Analysis

特定のビューやテンプレートのパフォーマンス問題を深く調査し、改善案をドキュメント化します。

## 手順

1. 対象となるビューやテンプレートファイルを特定
   - URLパターンから該当ビューを特定
   - テンプレート名とその使用箇所を確認
   - 関連するモデルとAPIを調査

2. パフォーマンス問題の分類
   - 常に発生する問題（全ケースで影響）
   - 特定条件下で発生する問題（大規模データ、ログインユーザーなど）
   - N+1問題の有無を確認
   - メモリ大量消費の箇所を特定

3. データベースクエリの分析
   - select_related/prefetch_relatedの使用状況確認
   - COUNT(*)クエリの実行回数
   - 複雑なJOINやサブクエリの特定
   - インデックスの使用状況確認

4. キャッシュ戦略の評価
   - @cached_propertyの使用状況
   - Redisキャッシュの活用度
   - テンプレートキャッシュの可能性

5. メモリ使用パターンの分析
   - list()による全件メモリ読み込み箇所を特定
   - 大量オブジェクトのインスタンス化
   - 不要なデータ取得（only()やdefer()の活用可能性）

6. 改善提案の作成
   - Phase 0: 緊急対応（即座に実装可能、数時間で完了）
   - Phase 1: クエリ最適化（1日以内）
   - Phase 2: データ構造最適化（1週間以内）
   - Phase 3: 非同期処理導入（2週間以内）
   - Phase 4: アーキテクチャ改善（1ヶ月以内）

7. パフォーマンス計測の推定
   - 現状の応答時間を推定
   - 各改善フェーズごとの期待効果を数値化
   - 最悪ケースと通常ケースを分けて分析

8. ドキュメント作成
   - docs/ディレクトリに日本語でマークダウンファイルを作成
   - 問題の概要、原因分析、改善提案、実装例を含める
   - モニタリング戦略とテスト計画も記載

## 特に注目すべきポイント

- forthcoming_events/past_eventsのような全件取得パターン
- total_participants_user_idsのような大量ID処理
- ソーシャル機能（フォロー/フォロワー）の処理コスト
- 大規模イベント（LARGE_EVENT_THRESHOLD）の判定と処理分岐
- フィード処理やページネーション
- グループ関連の集計処理

## 出力形式

ドキュメントには以下のセクションを含める：
- 問題の概要と影響範囲
- 問題の分類（常時/条件付き）
- パフォーマンス計測結果（推定）
- 改善戦略（Phase 0-4）
- 実装優先度と期待効果
- モニタリング戦略
- テスト計画
- リスクと注意事項
- 実装チェックリスト
- 結論と最優先事項